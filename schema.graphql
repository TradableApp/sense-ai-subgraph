# --- Chat Entities ---

# Mutable: Timestamps and Metadata CIDs update over time
type Conversation @entity(immutable: false) {
  id: ID!
  owner: Bytes!
  conversationId: BigInt!
  conversationCID: String!
  conversationMetadataCID: String!
  lastMessageCreatedAt: BigInt!
  createdAtBlock: BigInt!
  isDeleted: Boolean!
  messages: [Message!]! @derivedFrom(field: "conversation")
  promptRequests: [PromptRequest!]! @derivedFrom(field: "conversation")
  branchedFrom: Conversation
}

# Immutable: Once a message is sent, it is never altered on-chain
type Message @entity(immutable: true) {
  id: ID!
  messageId: BigInt!
  conversation: Conversation!
  messageCID: String!
  role: String!
  createdAt: BigInt!
  transactionHash: String!
  searchDelta: SearchDelta
}

# Immutable: Search keywords are static for a specific message
type SearchDelta @entity(immutable: true) {
  id: ID!
  message: Message!
  searchDeltaCID: String!
}

# --- Prompt Request (For Cancelled/Pending History) ---

# This stores the raw intent before it becomes a permanent Message.
type PromptRequest @entity(immutable: false) {
  id: ID! # This will be the answerMessageId
  promptMessageId: BigInt! # Stored for frontend reference
  conversation: Conversation!
  user: Bytes!
  encryptedPayload: Bytes!
  isCancelled: Boolean!
  isAnswered: Boolean!
  isRefunded: Boolean!
  createdAt: BigInt!
  transactionHash: String!
}

# --- Financial Entities ---

# Mutable: Status changes from PENDING -> COMPLETE
type Payment @entity(immutable: false) {
  id: ID! # escrowId
  user: Bytes!
  amount: BigInt!
  status: String! # "PENDING", "COMPLETE", "REFUNDED"
  createdAt: BigInt!
  finalizedAt: BigInt
  txHash: String!
}

# Mutable: Allowance and Expiry update over time
type SpendingLimit @entity(immutable: false) {
  id: ID! # user address
  user: Bytes!
  allowance: BigInt!
  expiresAt: BigInt!
  updatedAt: BigInt!
}

# --- Unified Activity Log ---

# Immutable: Represents a single, discrete on-chain action
type Activity @entity(immutable: true) {
  id: ID! # txHash-logIndex
  user: Bytes! # The user who performed the action
  type: String! # e.g., "CONVERSATION", "RENAME", "BRANCH", "CANCEL", "REFUND", "PLAN_UPDATE", "PLAN_REVOKE"
  amount: BigInt! # Can be negative (cost) or positive (refund). Wei.
  timestamp: BigInt! # Block timestamp
  transactionHash: Bytes!
}
